# UEFI Secure Boot Key Rotation Update Guide

## Overview

This guide describes the complete workflow for UEFI Secure Boot key rotation on DISTRO systems. The rotation process enables seamless transition from production keys (currently valid through 2027) to rotation-capable keys with extended 25-year validity.

**Key Architecture**:
- **Current Production Keys** (2017-2027, 10-year window):
  - Location: `/boot/loader/keys/production/` (deployed from meta-secure-core)
  - Signing authority: meta-secure-core (read-only reference)
  - Status: Active until August 2027
  - Naming convention: Uppercase (PK, KEK, DB, DBX)

- **Rotation Keys** (_next variants, 2025-2050, 25-year window):
  - Location: `/boot/loader/keys/rotation/` (generated by generate-rotation-keys.sh)
  - Signing authority: Self-signed each generation
  - Status: Ready for enrollment as replacement keys
  - Naming convention: Lowercase with _next suffix (PK_next, KEK_next, db_next, dbx_next)

- **Fallback Keys** (Emergency recovery):
  - Location: `/usr/share/distro/keys/production/` (embedded in image)
  - Purpose: Recovery without network/external media
  - Allows system recovery if rotation fails

## Timeline & Validity

```
Year:        2017      2020      2025      2027      2030      2050
             ├─────────┼─────────┼─────────┼─────────┼─────────┤
Production:  PK/KEK/db (10 years, expires Aug 2027)
Rotation:                        PK_next/KEK_next/db_next (25 years, valid through 2050)
             ├─ Current phase ──┤├─ Transition window ──┤├─ Future phase ───┤
```

**Critical Date**: August 12, 2027
- Production keys expire
- Rotation must be complete by this date
- Systems still using production keys will fail Secure Boot verification

**Recommended Window**: 2025-2026
- 1-2 years before expiry
- Time to test and deploy across fleet
- Allows gradual rollout to production systems

## Pre-Rotation Checklist

Before initiating key rotation, ensure:

- [ ] System running DISTRO with update-uefi-keys installed
- [ ] EFI firmware version up-to-date (especially Secure Boot support)
- [ ] Rotation keys generated and deployed: `/boot/loader/keys/rotation/`
- [ ] Available storage space: ≥ 500MB for backups
- [ ] Network connectivity (optional, for update server access)
- [ ] Backup of current system state (IMPORTANT)
- [ ] Access to UEFI setup/firmware menu (for emergency recovery)
- [ ] Knowledge of recovery procedures (see Recovery section)
- [ ] Test in non-production environment first

## Key Generation: Production Keys to Rotation Keys

### 1. Generate Rotation Keys from Production Keys

The `generate-rotation-keys.sh` script creates rotation-capable _next keys by:

1. Reading production keys from `/boot/loader/keys/production/` (or meta-secure-core reference)
2. Generating new PK_next, KEK_next, db_next, dbx_next with 25-year validity
3. Signing each _next key appropriately (self-signed or cross-signed per hierarchy)
4. Creating EFI Signature Lists (.esl format)
5. Creating authenticated variable files (.auth format) for UEFI enrollment
6. Outputting DER-format keys for firmware compatibility

**Command** (on build system):
```bash
# Generate rotation keys based on meta-secure-core production keys
./layers/meta-distro/files/secureboot/generate-rotation-keys.sh \
  layers/meta-secure-core/meta-signing-key/files/uefi_sb_keys \
  11111111-2222-3333-4444-123456789abc

# Output: rotation/ directory with _next keys
#   - PK_next.key, PK_next.crt, PK_next.esl, PK_next.auth, PK_next.der
#   - KEK_next.key, KEK_next.crt, KEK_next.esl, KEK_next.auth, KEK_next.der
#   - db_next.key, db_next.crt, db_next.esl, db_next.auth, db_next.der
#   - dbx_next.key, dbx_next.crt, dbx_next.esl, dbx_next.auth, dbx_next.der
```

### 2. Deploy Rotation Keys to Image

The BitBake recipe deployment process:

1. `bitbake core-image-minimal` includes rotation keys
2. Rotation keys deployed to `/boot/loader/keys/rotation/` in image
3. Update script included: `/usr/local/sbin/update-uefi-keys.sh`
4. Fallback keys embedded: `/usr/share/distro/keys/production/`

**Build Command**:
```bash
source layers/poky/oe-init-build-env
bitbake core-image-minimal
# Image includes rotation keys ready for enrollment
```

## Runtime Key Rotation Procedure

### Step 1: Pre-Rotation Validation (Dry-Run)

**Purpose**: Test key validation without making any changes

```bash
sudo /usr/local/sbin/update-uefi-keys.sh --action dry-run

# Output:
# [INFO] 2025-01-15 10:00:00 - Script started (action: dry-run)
# [INFO] 2025-01-15 10:00:01 - EFI environment validated
# [INFO] 2025-01-15 10:00:02 - All rotation key files validated
# [INFO] 2025-01-15 10:00:03 - All key signatures validated
# [INFO] 2025-01-15 10:00:04 - The following actions would be performed:
#   1. Create backup checkpoint of current keys
#   2. Enroll rotation keys in UEFI firmware
#   3. Validate enrollment
#   4. Reboot required to complete transition
```

**Troubleshooting Dry-Run Failures**:

| Error | Cause | Solution |
|-------|-------|----------|
| "EFI system partition not found" | Not booted in EFI mode | Boot system in UEFI mode |
| "efivarfs not mounted" | EFI variables not accessible | `mount -t efivarfs efivarfs /sys/firmware/efi/efivars` |
| "Must be run as root" | Missing sudo | Use `sudo` prefix |
| "Missing rotation key" | Keys not deployed | Rebuild/redeploy image with rotation keys |
| "Invalid .auth file format" | Corrupted keys | Regenerate using `generate-rotation-keys.sh` |

### Step 2: Create System Backup (Critical)

```bash
# RECOMMENDED: Create full system backup before rotation
sudo tar czf /mnt/backup/distro-pre-rotation-$(date +%Y%m%d).tar.gz \
  /boot/loader/keys/production \
  /etc/default \
  /etc/systemd \
  --exclude=/proc --exclude=/sys --exclude=/dev

# Backup also persists in: /boot/loader/keys/backup/ (auto-created during rotation)
```

### Step 3: Perform Rotation

**Command**:
```bash
sudo /usr/local/sbin/update-uefi-keys.sh --action rotate

# Output:
# [INFO] 2025-01-15 10:05:00 - ===========================================
# [INFO] 2025-01-15 10:05:00 - UEFI Secure Boot Key Rotation
# [INFO] 2025-01-15 10:05:00 - ===========================================
# [INFO] 2025-01-15 10:05:01 - EFI environment validated
# [INFO] 2025-01-15 10:05:02 - All rotation key files validated
# [INFO] 2025-01-15 10:05:03 - All key signatures validated
# [INFO] 2025-01-15 10:05:04 - Creating backup checkpoint of current keys...
# [INFO] 2025-01-15 10:05:05 - Backup checkpoint created at: /boot/loader/keys/rollback/checkpoint-1705315505
# [INFO] 2025-01-15 10:05:06 - Proceeding with key enrollment...
# [INFO] 2025-01-15 10:05:07 - Enrolling rotation keys in UEFI firmware...
# [INFO] 2025-01-15 10:05:08 - ✓ PK_next enrolled successfully
# [INFO] 2025-01-15 10:05:09 - ✓ KEK_next enrolled successfully
# [INFO] 2025-01-15 10:05:10 - ✓ db_next enrolled successfully
# [INFO] 2025-01-15 10:05:11 - ✓ dbx_next enrolled successfully
# [INFO] 2025-01-15 10:05:12 - All rotation keys enrolled successfully
# [INFO] 2025-01-15 10:05:13 - All rotation keys confirmed enrolled
# [INFO] 2025-01-15 10:05:13 - ===========================================
# [INFO] 2025-01-15 10:05:13 - Key Rotation Successful
# [INFO] 2025-01-15 10:05:13 - ===========================================
# [INFO] 2025-01-15 10:05:13 - Checkpoint location: /boot/loader/keys/rollback/checkpoint-1705315505
# [INFO] 2025-01-15 10:05:13 -
# [INFO] 2025-01-15 10:05:13 - IMPORTANT: A system reboot is required to activate the new keys
# [INFO] 2025-01-15 10:05:13 - Reboot with: sudo reboot
```

**What the Script Does**:

1. **Validation Phase**:
   - Checks EFI environment accessibility
   - Validates all .auth files present and properly formatted
   - Verifies signatures on rotation keys
   - Returns error if any checks fail

2. **Backup Phase**:
   - Creates timestamped checkpoint: `/boot/loader/keys/rollback/checkpoint-<timestamp>/`
   - Backs up current PK UEFI variable (if accessible)
   - Backs up current production key files
   - Backs up fallback keys for emergency recovery
   - Stores checkpoint path for potential rollback

3. **Enrollment Phase**:
   - Enrolls keys in proper order: PK_next → KEK_next → db_next → dbx_next
   - Uses `efi-updatevar` tool for UEFI variable updates
   - Adds 1-second delays between enrollments for firmware processing
   - Validates each enrollment succeeded before continuing

4. **Verification Phase**:
   - Checks if new keys are present in UEFI (using `efi-readvar`)
   - Confirms successful enrollment
   - Provides reboot instructions

### Step 4: Reboot System

**CRITICAL**: Reboot is required for new keys to take effect

```bash
sudo reboot

# System will:
# 1. Perform POST with new keys
# 2. Load u-boot.efi from ESP with new db_next signature validation
# 3. Validate kernel signatures with new db_next
# 4. Boot successfully if all signatures match
```

### Step 5: Verify Rotation Success

**After Reboot**:
```bash
# Check system booted successfully
sudo dmesg | head -20

# Verify new keys in UEFI (if efi-readvar available)
efi-readvar PK
efi-readvar KEK
efi-readvar db
efi-readvar dbx

# Check audit log for rotation success
sudo journalctl -u systemd-update-utmp.service
sudo cat /var/log/distro/uefi-key-rotation.log | tail -20
```

**Expected Signs of Success**:
- ✅ System boots normally
- ✅ No Secure Boot errors in firmware
- ✅ dmesg shows no security warnings
- ✅ efi-readvar shows _next key signatures
- ✅ Audit log shows all steps completed

## Exception Handling & Recovery

### Scenario 1: Rotation Fails - Key Enrollment Error

**Symptoms**:
- Script outputs: `[ERROR] Failed to enroll <key>`
- System does not reboot before rollback
- Checkpoint created (saved at: `/boot/loader/keys/rollback/checkpoint-<timestamp>/`)

**Automatic Response**:
- Script automatically initiates rollback
- Restores production keys from checkpoint
- Logs: `[WARN] Rolling back to production keys...`

**Manual Verification**:
```bash
# Check rollback was successful
sudo cat /var/log/distro/uefi-key-rotation.log | grep -i rollback

# System should still have production keys active
# No reboot occurred
```

### Scenario 2: System Won't Boot After Rotation

**Symptoms**:
- Secure Boot failure message
- "Signature Verification Failed" error
- System halts before OS loads

**Root Cause**:
- New rotation keys not properly signed
- Kernel/u-boot signatures don't match new db_next keys
- Firmware didn't enroll rotation keys correctly

**Recovery Procedure**:

**Option 1: Rollback from Running System** (if you can still SSH)
```bash
# From another system or SSH access:
ssh root@target-system

sudo /usr/local/sbin/update-uefi-keys.sh --action rollback

# System will restore production keys
# Then reboot to activate
sudo reboot
```

**Option 2: UEFI Firmware Menu Recovery** (if can't boot OS)
```bash
1. Power off system
2. Boot to UEFI/BIOS setup (usually DEL, F2, or ESC during startup)
3. Navigate to Secure Boot settings
4. Select "Restore Factory Defaults" or "Reset to Setup Mode"
   - Clears all custom keys
   - Returns to production keys (if enabled)
5. Save and exit
6. System will boot with production keys
```

**Option 3: Boot from Rescue Media** (if need to restore completely)
```bash
# From USB with distro-rescue image:
1. Boot from rescue media
2. Mount root filesystem
3. Run: /mnt/root/usr/local/sbin/update-uefi-keys.sh --action rollback
4. Reboot to production keys
```

**Option 4: Manual Restoration from Checkpoint**
```bash
# If UEFI variables still accessible:
CHECKPOINT_DIR="/boot/loader/keys/rollback/checkpoint-<timestamp>"
PROD_KEYS="${CHECKPOINT_DIR}/current-keys"

# Restore production keys
sudo rm -rf /boot/loader/keys/production
sudo cp -r "${PROD_KEYS}" /boot/loader/keys/production

# Re-enroll with alternative method:
# - Use UEFI firmware UI to clear and re-enroll
# - Or boot from rescue media to complete restoration
```

### Scenario 3: Rotation Succeeds but Reboot Fails

**Symptoms**:
- Rotation script completes successfully
- System reboots
- Secure Boot error appears
- System won't complete boot

**Cause**:
- Rotation keys enrolled, but signatures don't match loaded kernel
- Kernel image was updated between rotation and reboot
- Rotation keys missing signature for current kernel

**Recovery**:

**Option A: Boot Previous Kernel**
```bash
# From UEFI boot menu:
1. Select alternative kernel entry (if available)
2. Try previous kernel version
3. If boots: Update kernel signatures or rebuild with rotation keys
```

**Option B: Access Rollback from UEFI** (if partition accessible)
```bash
1. Boot to UEFI shell
2. Navigate to EFI partition
3. Run recovery script if available
```

**Option C: Physical Recovery**
```bash
1. Remove drive from system
2. Mount on another system with distro
3. Run: /usr/local/sbin/update-uefi-keys.sh --action rollback
4. Reboot original system
```

### Scenario 4: Partial Enrollment - Some Keys Enrolled

**Symptoms**:
- Script reports enrollment of PK_next and KEK_next
- Reports failure on db_next or dbx_next
- System partially transitioned

**Recovery**:
```bash
# Automatic: Script performs rollback on failure
# Manual verification:
sudo cat /var/log/distro/uefi-key-rotation.log | grep -A5 "db_next"

# Check current UEFI state
efi-readvar PK
efi-readvar KEK
efi-readvar db
efi-readvar dbx

# If only partial keys enrolled:
sudo /usr/local/sbin/update-uefi-keys.sh --action rollback
sudo reboot
```

### Scenario 5: Fallback Key Activation

**Symptoms**:
- System completely unbootable
- Can't access UEFI or rollback
- Need emergency recovery

**Built-in Fallback**:
- Every DISTRO image includes fallback production keys
- Location: `/usr/share/distro/keys/production/`
- Update script can restore from fallback if:
  - System still boots (can run script)
  - Checkpoint directory lost/corrupted
  - Original key files deleted

**Automatic Activation**:
```bash
# Script detects checkpoint missing:
# 1. Logs: [ERROR] No checkpoint found for rollback
# 2. Attempts: [INFO] Attempting to restore from fallback...
# 3. Restores: /usr/share/distro/keys/production/ → /boot/loader/keys/production/
# 4. System returns to factory-default production keys
```

**Manual Fallback Activation**:
```bash
# If script can't auto-restore:
sudo rm -rf /boot/loader/keys/production
sudo cp -r /usr/share/distro/keys/production /boot/loader/keys/production

# Then invoke rollback or re-enroll:
sudo /usr/local/sbin/update-uefi-keys.sh --action rollback
```

## Exception Handling Features

### 1. Pre-Rotation Validation

**Executed Before Any Changes**:
- EFI environment accessible
- efivarfs mounted properly
- Running as root
- All rotation key files present
- Key signatures valid
- Sufficient disk space

**Exit on Failure**: Script exits with error code 1 if any check fails

### 2. Backup Checkpoint System

**Created Before Enrollment**:
- Timestamped directory with current state
- Backed up current UEFI PK variable
- Copied current production key files
- Copied fallback keys for recovery
- Stored in: `/boot/loader/keys/rollback/checkpoint-<timestamp>/`

**Preserves**:
- Full recovery path to previous state
- Audit trail of rotation attempts
- Fallback for emergency restoration

### 3. Automatic Rollback on Failure

**Triggered If**:
- Key signature validation fails
- Enrollment of any key fails
- Post-enrollment verification fails

**Actions**:
1. Logs error with details
2. Checks for most recent checkpoint
3. Attempts restoration from checkpoint
4. Falls back to fallback keys if checkpoint unavailable
5. Logs success/failure of rollback
6. Provides manual recovery instructions if rollback fails

### 4. Exception Handling

**Script-Level**:
- `set -o pipefail` - Catch pipe failures
- `trap` handlers for INT/TERM/EXIT
- Timeout protection (30-second timeout for operations)
- Validation retries (3 attempts for critical operations)

**Logging**:
- All operations logged to `/var/log/distro/uefi-key-rotation.log`
- Audit trail with timestamps
- Error details for troubleshooting
- Rollback actions recorded

**Recovery Points**:
- Checkpoint saved before any changes
- Fallback keys embedded in image
- Manual recovery procedures documented
- UEFI firmware reset available

## Audit Logging

All rotation operations logged to `/var/log/distro/uefi-key-rotation.log`

**Log Entry Format**:
```
[LEVEL] YYYY-MM-DD HH:MM:SS - Message
```

**Log Levels**:
- `[INFO]` - Standard operations
- `[WARN]` - Potential issues (non-fatal)
- `[ERROR]` - Failed operations requiring attention
- `[DEBUG]` - Detailed diagnostic info (verbose mode)

**Sample Log**:
```
[INFO] 2025-01-15 10:05:00 - Script started (action: rotate)
[INFO] 2025-01-15 10:05:01 - EFI environment validated
[INFO] 2025-01-15 10:05:02 - All rotation key files validated
[INFO] 2025-01-15 10:05:03 - All key signatures validated
[INFO] 2025-01-15 10:05:04 - Creating backup checkpoint of current keys...
[INFO] 2025-01-15 10:05:05 - Backup checkpoint created at: /boot/loader/keys/rollback/checkpoint-1705315505
[INFO] 2025-01-15 10:05:06 - Enrolling rotation keys in UEFI firmware...
[DEBUG] 2025-01-15 10:05:07 - Enrolling PK_next...
[INFO] 2025-01-15 10:05:08 - ✓ PK_next enrolled successfully
```

**Reviewing Logs**:
```bash
# View rotation history
sudo tail -50 /var/log/distro/uefi-key-rotation.log

# Search for errors
sudo grep ERROR /var/log/distro/uefi-key-rotation.log

# View specific rotation attempt
sudo grep "2025-01-15 10:05" /var/log/distro/uefi-key-rotation.log
```

## Testing & Validation

### Pre-Deployment Testing

Recommended testing sequence before production rollout:

1. **Lab Environment**:
   - Build image with rotation keys
   - Test in QEMU with OVMF firmware
   - Validate generate-rotation-keys.sh output

2. **Non-Production Hardware**:
   - Deploy to test system matching production config
   - Run: `--action dry-run` (no changes)
   - Review output and log
   - Perform full rotation cycle
   - Test rollback procedure
   - Verify system boots successfully

3. **Production Pilot**:
   - Deploy to 5-10 production systems
   - Monitor boot logs
   - Collect audit logs
   - Verify Secure Boot still enforced
   - Test rollback on 1-2 systems
   - Document any issues

4. **Fleet Rollout**:
   - After pilot validation
   - Deploy to 25% of fleet
   - Monitor for issues
   - Expand to 100% if successful

### Validation Checklist

**Pre-Rotation**:
- [ ] System boots normally with production keys
- [ ] EFI Secure Boot enabled in firmware
- [ ] `efi-readvar` shows current keys correctly
- [ ] Dry-run completes without errors
- [ ] Rotation keys validated and deployed

**Post-Rotation**:
- [ ] System boots successfully
- [ ] No Secure Boot errors
- [ ] `efi-readvar` shows rotation keys enrolled
- [ ] Audit log shows all steps completed
- [ ] Performance/timing normal
- [ ] Services started correctly

**Post-Rollback**:
- [ ] System returns to production keys
- [ ] System boots successfully
- [ ] `efi-readvar` shows production keys
- [ ] No boot errors
- [ ] Services functioning normally

## Best Practices

### 1. Schedule Rotation Carefully

- Avoid during critical business hours
- Plan for 1-2 hour maintenance window
- Have rollback team available
- Schedule 6-12 months before key expiry (Aug 2027)

### 2. Backup Strategy

- Full system backup before rotation
- Archive checkpoint directories
- Document key rotation timeline
- Keep fallback keys accessible

### 3. Test Thoroughly

- Test on non-production systems first
- Validate rollback procedures work
- Ensure all automation handles rotation
- Document manual steps

### 4. Monitoring & Alerting

- Monitor boot logs post-rotation
- Alert on Secure Boot failures
- Track successful rotations per system
- Document any issues in audit trail

### 5. Documentation

- Document rotation timeline for organization
- Keep contact info for emergency procedures
- Maintain rollback documentation
- Update compliance records

### 6. Communication

- Notify users before maintenance window
- Explain what rotation means
- Provide rollback timeline if needed
- Post-rotation confirmation communication

## Frequently Asked Questions

**Q: What if I don't rotate before August 2027?**

A: Existing systems with production keys will fail Secure Boot verification. New systems must use rotation keys. Rotation is recommended by 2026 for adequate testing time.

**Q: Can I selectively update only some keys?**

A: No. The rotation process enrolls all four keys (PK_next, KEK_next, db_next, dbx_next) together. This maintains security hierarchy integrity.

**Q: Is it safe to rollback after reboot?**

A: Yes, but requires: (1) system must boot OS successfully (can run rollback script), or (2) access to emergency recovery tools. If system won't boot, use UEFI firmware recovery or physical recovery procedures.

**Q: What if rotation keys are corrupted?**

A: Regenerate using:
```bash
./generate-rotation-keys.sh /path/to/production/keys
```

**Q: Can I test rotation without committing?**

A: Yes:
```bash
sudo /usr/local/sbin/update-uefi-keys.sh --action dry-run
```

This validates everything without making changes.

**Q: How long does rotation take?**

A: Typical rotation: 30-60 seconds. Reboot after completion required (5-15 minutes depending on system).

**Q: What if system has TPM/Measured Boot?**

A: Rotation keys must have valid signatures in Secure Boot db. TPM measurements unaffected. PCR7 (Secure Boot state) may change; systems relying on PCR7 sealing should update their policies.

## Support & Escalation

**Level 1: Self-Help**
- Review this guide (you are here)
- Check `/var/log/distro/uefi-key-rotation.log`
- Run `--action dry-run` first
- Test rollback procedure

**Level 2: Recovery**
- Use automatic rollback feature
- Access UEFI firmware menu
- Boot from rescue media
- Run manual restore procedures

**Level 3: Hardware Recovery**
- Remove drive and recover on another system
- Use fallback keys for restoration
- Contact hardware vendor for Secure Boot support
- Physical key recovery (see UEFI spec)

**Documentation**:
- This guide: UEFI Secure Boot Key Rotation Update Guide
- Technical: `generate-rotation-keys.sh` source code
- Reference: `/boot/loader/keys/` directory structure
- Logs: `/var/log/distro/uefi-key-rotation.log`

---

**Document Version**: 1.0
**Last Updated**: January 2025
**Valid For**: DISTRO systems with update-uefi-keys.sh >= 1.0
**Key Rotation Timeline**: Recommended by 2026, required by August 2027
