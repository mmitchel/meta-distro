# Kernel configuration fragment for Docker support
# Includes cgroups v2, namespaces, and container runtime requirements

# Control Groups (cgroups) v2 - Unified hierarchy
CONFIG_CGROUPS=y

# Disable cgroups v1 to prefer cgroups v2 unified hierarchy
# This ensures systemd and Docker use cgroups v2 by default
# CONFIG_CGROUP_SCHED is not set

# Enable cgroups v2 controllers
CONFIG_CGROUP_FREEZER=y
CONFIG_CGROUP_PIDS=y
CONFIG_CGROUP_DEVICE=y
CONFIG_CGROUP_CPUACCT=y
CONFIG_CGROUP_BPF=y

# Memory control group (memcg) for cgroups v2
CONFIG_MEMCG=y
CONFIG_MEMCG_KMEM=y

# Block IO controller for cgroups v2
CONFIG_BLK_CGROUP=y
CONFIG_BLK_DEV_THROTTLING=y

# Namespaces support
CONFIG_NAMESPACES=y
CONFIG_UTS_NS=y
CONFIG_IPC_NS=y
CONFIG_PID_NS=y
CONFIG_NET_NS=y
CONFIG_USER_NS=y

# IPv4 support for Docker
CONFIG_INET=y
CONFIG_IP_MULTICAST=y
CONFIG_IP_ADVANCED_ROUTER=y
CONFIG_IP_MULTIPLE_TABLES=y
CONFIG_IP_ROUTE_MULTIPATH=y
CONFIG_IP_ROUTE_VERBOSE=y
CONFIG_IP_PNP=y
CONFIG_IP_PNP_DHCP=y
CONFIG_NET_IPIP=y
CONFIG_NET_IPGRE=y
CONFIG_NET_IPGRE_DEMUX=y
CONFIG_IP_MROUTE=y
CONFIG_IP_PIMSM_V1=y
CONFIG_IP_PIMSM_V2=y
CONFIG_SYN_COOKIES=y

# IPv6 support for Docker
CONFIG_IPV6=y
CONFIG_IP6_NF_IPTABLES=m
CONFIG_IP6_NF_FILTER=m
CONFIG_IP6_NF_TARGET_REJECT=m
CONFIG_IP6_NF_NAT=m
CONFIG_IP6_NF_TARGET_MASQUERADE=m
CONFIG_IP6_NF_MANGLE=m
CONFIG_NF_DEFRAG_IPV6=m

# Networking for containers
CONFIG_NETFILTER=m
CONFIG_NETFILTER_ADVANCED=m
CONFIG_NETFILTER_XTABLES=m
CONFIG_NETFILTER_XT_MATCH_ADDRTYPE=m
CONFIG_NETFILTER_XT_MATCH_CONNTRACK=m
CONFIG_NETFILTER_XT_MATCH_IPVS=m
CONFIG_NETFILTER_XT_MARK=m
CONFIG_NETFILTER_XT_TARGET_NAT=m
CONFIG_NETFILTER_XT_TARGET_MASQUERADE=m

CONFIG_NF_NAT=m

CONFIG_IP_NF_IPTABLES=m
CONFIG_IP_NF_FILTER=m
CONFIG_IP_NF_TARGET_REJECT=m
CONFIG_IP_NF_NAT=m
CONFIG_IP_NF_TARGET_MASQUERADE=m
CONFIG_IP_NF_MANGLE=m

# Bridge networking
CONFIG_BRIDGE=m
CONFIG_BRIDGE_NETFILTER=m
CONFIG_BRIDGE_VLAN_FILTERING=m

CONFIG_VETH=m
CONFIG_VXLAN=m

# Overlay filesystem for container layers
CONFIG_OVERLAY_FS=y
CONFIG_OVERLAY_FS_REDIRECT_DIR=y
CONFIG_OVERLAY_FS_INDEX=y

# Security and capabilities
CONFIG_SECCOMP=y
CONFIG_SECCOMP_FILTER=y
CONFIG_SECURITY=y
CONFIG_SECURITY_NETWORK=y
CONFIG_SECURITY_APPARMOR=y

# Limit support (ulimit, prlimit)
CONFIG_POSIX_MQUEUE=y

# VLAN support
CONFIG_VLAN_8021Q=y

# MACVLAN support
CONFIG_MACVLAN=m
CONFIG_IPVLAN=m

# IP Virtual Server for load balancing (Docker Swarm)
CONFIG_IP_VS=m
CONFIG_IP_VS_PROTO_TCP=m
CONFIG_IP_VS_PROTO_UDP=m
CONFIG_IP_VS_RR=m
CONFIG_IP_VS_WRR=m
CONFIG_IP_VS_SH=m
CONFIG_IP_VS_NFCT=m

# Netfilter connection tracking
CONFIG_NF_CONNTRACK=m
CONFIG_NF_CONNTRACK_MARK=m

# Network priority and classifiers
CONFIG_NET_CLS_CGROUP=y
CONFIG_NET_SCH_INGRESS=y
CONFIG_NET_SCHED=y

# Packet scheduling
CONFIG_NET_SCH_HTB=y

# eBPF support for modern container networking
CONFIG_BPF=y
CONFIG_BPF_SYSCALL=y
CONFIG_BPF_JIT=y
CONFIG_HAVE_EBPF_JIT=y

# Audit support for security
CONFIG_AUDIT=y

# Quota support
CONFIG_QUOTA=y
CONFIG_QUOTACTL=y

# Tmpfs/shmem support for containers
CONFIG_TMPFS=y
CONFIG_TMPFS_POSIX_ACL=y
CONFIG_TMPFS_XATTR=y

# Hugetlbfs for performance
CONFIG_HUGETLBFS=y
CONFIG_HUGETLB_PAGE=y
